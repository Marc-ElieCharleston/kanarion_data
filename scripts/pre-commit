#!/bin/bash
# Pre-commit hook: verifies that content_hash is up to date
# Installation: cp scripts/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

set -e
cd "$(git rev-parse --show-toplevel)"

# Check if any gameplay JSON files have been staged
STAGED_JSON=$(git diff --cached --name-only --diff-filter=ACMR \
  | grep '\.json$' \
  | grep -v 'kanarion-editor/' \
  | grep -v '_meta/version.json' \
  | grep -v '_meta/statistics.json' \
  | grep -v '_meta/index.json' \
  | grep -v '_meta/changelog.json' \
  | grep -v '_meta/ideas_to_integrate.json' \
  || true)

if [ -n "$STAGED_JSON" ]; then
  # Gameplay JSON files are modified â€” verify hash is fresh
  EXPECTED=$(find . -name "*.json" \
    -not -path "./.git/*" \
    -not -path "./kanarion-editor/*" \
    -not -path "./scripts/*" \
    -not -path "./_meta/version.json" \
    -not -path "./_meta/statistics.json" \
    -not -path "./_meta/index.json" \
    -not -path "./_meta/changelog.json" \
    -not -path "./_meta/ideas_to_integrate.json" \
    | sort \
    | while read f; do echo "$f"; cat "$f"; done \
    | sha256sum | cut -d' ' -f1)

  ACTUAL=$(python -c "import json; print(json.load(open('_meta/version.json')).get('content_hash','').replace('sha256:',''))" 2>/dev/null || echo "")

  if [ "$EXPECTED" != "$ACTUAL" ]; then
    echo "ERROR: content_hash is stale!"
    echo "JSON gameplay files were modified but hash was not regenerated."
    echo ""
    echo "Run: ./scripts/gen_hash.sh"
    echo "Then: git add _meta/version.json"
    echo ""
    exit 1
  fi
fi
